# Schema for pen tracer V2 configuration
# Dual-mode extraction: edges + gamut-aware shadow hatching

schema: pen_tracer.v2

# Output resolution settings
output:
  # Target height for pen layer generation
  # Width is computed automatically to maintain aspect ratio
  # If null, uses original image resolution
  target_height_px: 1080  # HD height (1080p), or null for original
  
  # Minimum resolution (safety limit)
  min_px: 512
  
  # Maximum resolution (memory limit)
  max_px: 4096

# Edge detection (outline extraction)
edge_detection:
  enabled: true
  
  # Canny edge detection thresholds
  canny_low: 50.0       # Lower hysteresis threshold (20-100)
  canny_high: 150.0     # Upper hysteresis threshold (100-300)
  
  # Edge filtering
  min_length_px: 20     # Minimum edge length to keep (10-100)
  link_distance_px: 2   # Gap to link nearby edges (0-5)
  
  # Vectorization
  simplify_tol_px: 1.5  # Douglas-Peucker tolerance (0.5-3.0)

# Shadow hatching (darkness filling)
shadow_hatching:
  enabled: true
  
  # Color gamut filtering
  # Only hatch regions that CMY airbrush cannot reproduce
  gamut_aware: true
  
  # Gamut definition (will be loaded from calibration if available)
  # These are fallback values for when calibration data is not available
  cmy_gamut:
    # Maximum darkness achievable with CMY (L* in LAB space)
    # Anything darker than this needs pen hatching
    min_luminance: 15.0   # L* value (0-100), ~95% black
    
    # Chroma limits (how saturated CMY can get)
    # Colors outside this need pen for saturation boost
    max_chroma: 80.0      # Chroma in LAB (0-150)
    
    # Hue ranges CMY can reproduce well (degrees in LAB)
    # Outside these ranges, pen may be needed
    hue_ranges:
      - [0, 360]  # Full range for now (will be refined by calibration)
  
  # Darkness levels and hatching intensity
  # Only applied to regions outside CMY gamut
  # IMPORTANT: Use single-direction hatching to leave space for CMY colors
  darkness_levels:
    - l_max: 30.0         # Very dark (nearly black)
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
      
    - l_max: 50.0         # Dark
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
      
    - l_max: 70.0         # Medium dark
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
  
  # Morphology
  min_area_px: 500        # Minimum shadow region size (100-2000)
  
  # Hatching pattern
  # Increase spacing to leave room for CMY colors to show through
  spacing_scale: 2.5      # Multiplier for hatch spacing (2.5x = sparse)
  
  # Line proximity limits
  min_line_spacing_mm: 0.5 # Minimum distance between parallel lines (mm)
  
# Gamut calibration integration
calibration:
  # Path to calibration data (optional)
  # If provided, overrides cmy_gamut fallback values
  calibration_file: null  # e.g., "outputs/calibration/cmy_gamut.yaml"
  
  # Gamut expansion margin (safety factor)
  # Expand CMY gamut by this much to avoid gaps
  # 0.0 = exact gamut, 0.1 = 10% expansion
  margin: 0.05

# Debug output
debug:
  save_intermediates: true
  save_gamut_mask: true     # Save mask of out-of-gamut regions
  save_edge_mask: true
  save_shadow_masks: true

