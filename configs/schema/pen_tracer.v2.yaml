# Schema for pen tracer V2 configuration
# Dual-mode extraction: edges + gamut-aware shadow hatching

schema: pen_tracer.v2

# Output resolution settings
output:
  # Target height for pen layer generation
  # Width is computed automatically to maintain aspect ratio
  # If null, uses original image resolution
  target_height_px: 1080  # HD height (1080p), or null for original
  
  # Minimum resolution (safety limit)
  min_px: 512
  
  # Maximum resolution (memory limit)
  max_px: 4096

# Edge detection (outline extraction)
edge_detection:
  enabled: true
  
  # Bilateral filter preprocessing (eliminates gradient artifacts)
  bilateral_d: 9                   # Neighborhood diameter (5-15)
  bilateral_sigma_color: 75        # Color smoothing (50-150)
  bilateral_sigma_space: 75        # Spatial smoothing (50-150)
  
  # Canny edge detection
  canny_low: 30.0                  # Low threshold (10-100, lower = more edges)
  canny_high: 100.0                # High threshold (50-200)
  sigma_px: 1.2                    # Gaussian blur sigma (0.5-3.0)
  
  # Morphological operations
  closing_kernel_size: 5           # Connect edge fragments (3-9)
  merge_kernel_size: 3             # Merge parallel skeletons (1-5)
  
  # Filtering & simplification
  min_length_px: 50                # Discard short edges (10-100)
  simplify_tol_px: 0.5             # Douglas-Peucker tolerance (0.5-5.0)

# Shadow hatching (darkness filling)
shadow_hatching:
  enabled: true
  
  # Color gamut filtering
  # Only hatch regions that CMY airbrush cannot reproduce
  gamut_aware: true
  
  # Gamut definition (will be loaded from calibration if available)
  # These are fallback values for when calibration data is not available
  cmy_gamut:
    # Maximum darkness achievable with CMY (L* in LAB space)
    # Anything darker than this needs pen hatching
    min_luminance: 15.0   # L* value (0-100), ~95% black
    
    # Chroma limits (how saturated CMY can get)
    # Colors outside this need pen for saturation boost
    max_chroma: 80.0      # Chroma in LAB (0-150)
    
    # Hue ranges CMY can reproduce well (degrees in LAB)
    # Outside these ranges, pen may be needed
    hue_ranges:
      - [0, 360]  # Full range for now (will be refined by calibration)
  
  # Darkness levels and hatching intensity
  # Only applied to regions outside CMY gamut
  # IMPORTANT: Use single-direction hatching to leave space for CMY colors
  darkness_levels:
    - l_max: 30.0         # Very dark (nearly black)
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
      
    - l_max: 50.0         # Dark
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
      
    - l_max: 70.0         # Medium dark
      passes: 1           # Single pass only
      hatch_angles: [45]  # Single direction
  
  # Morphology
  min_area_px: 500        # Minimum shadow region size (100-2000)
  
  # Gap closing (connect nearby regions to reduce pen lifts)
  # TUNING GUIDE:
  #   Higher values → fewer, longer strokes (less pen lifts, smoother)
  #   Lower values → more faithful to original, but more dots/gaps
  # RECOMMENDED RANGES:
  #   0-1 px:  Very precise, many small segments
  #   2-3 px:  Balanced - connects nearby regions (RECOMMENDED)
  #   4-5 px:  Aggressive - very smooth but may over-connect
  # EFFECT: Reduces "dotting" where color is slightly outside range
  close_gaps_px: 3        # Morphological closing kernel size (0-5)
  
  # Hatching pattern
  # Increase spacing to leave room for CMY colors to show through
  spacing_scale: 2.5      # Multiplier for hatch spacing (2.5x = sparse)
  
  # Line proximity limits
  min_line_spacing_mm: 0.5 # Minimum distance between parallel lines (mm)
  
  # Minimum segment length (filter out tiny dots and strokes)
  # TUNING GUIDE:
  #   Higher values → cleaner output, but may lose small details
  #   Lower values → keeps all details, but more pen lifts
  # RECOMMENDED RANGES:
  #   0.5-1.0 mm:  Keep most details
  #   1.0-2.0 mm:  Balanced - remove dots but keep small features (RECOMMENDED)
  #   2.0-5.0 mm:  Aggressive - only long strokes
  # EFFECT: Removes tiny disconnected segments that look like dots
  # NOTE: Closed contours (circles) are kept if their perimeter > min_length
  min_segment_length_mm: 1.5  # Minimum hatch line length (mm)
  
# Gamut calibration integration
calibration:
  # Path to calibration data (optional)
  # If provided, overrides cmy_gamut fallback values
  calibration_file: null  # e.g., "outputs/calibration/cmy_gamut.yaml"
  
  # Gamut expansion margin (safety factor)
  # Expand CMY gamut by this much to avoid gaps
  # 0.0 = exact gamut, 0.1 = 10% expansion
  margin: 0.05

# Debug output
debug:
  save_intermediates: true
  save_gamut_mask: true     # Save mask of out-of-gamut regions
  save_edge_mask: true
  save_shadow_masks: true

