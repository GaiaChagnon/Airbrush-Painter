# machine.yaml - Hardware configuration for Octopus Pro Painter
#
# Single source of truth for machine dimensions, stepper hardware, and tool
# configuration.  The code reads this file at startup via configs/loader.py.
# Change values here -- do NOT hardcode them in Python.
#
# All linear dimensions are in millimeters.
# All feed/speed values are in mm/s (converted to mm/min at G-code boundary).
#
# Values validated against hardware bring-up (test_motors.py, 2026-02-12).

# --- Klipper API connection ------------------------------------------------
connection:
  socket_path: "/tmp/klippy_uds"
  timeout_s: 10.0                    # Must cover slow Z homing; bump if timeouts occur
  reconnect_attempts: 5            # Retries if Octopus was power-cycled
  reconnect_interval_s: 2.0        # Seconds between reconnect attempts
  auto_reconnect: true             # Re-establish connection on MCU reset
  mcu_serial: "/dev/serial/by-id/usb-Klipper_stm32h723xx_130028001051313234353230-if00"

# --- Physical work area (measure your machine) -----------------------------
# These are the ACTUAL travel limits of each axis in mm.
# Must match position_min/position_max in printer.cfg.
machine:
  work_area_mm:
    x: 450.0                       # Validated during bring-up
    y: 320.0                       # Validated during bring-up
    z: 80.0                        # Seesaw belt: 80 mm total travel

  # Soft limits: scripts clamp all commanded positions to this range.
  # Set these inside the physical travel to protect endstops / mechanics.
  # Units: mm.  z_min/z_max must be within [0, work_area_mm.z].
  soft_limits:
    z_min: 2.0                     # 2 mm above Z=0 endstop
    z_max: 80.0                    # Full travel allowed (endstop at 80)

# --- Canvas position within work area (airbrush system) --------------------
# Used by the airbrush G-code generator and interactive controller origin.
# Pen tracer uses paper placement from jobs.yaml instead.
canvas:
  offset_x_mm: 10.0                # Distance from X home to canvas left edge
  offset_y_mm: 10.0                # Distance from Y home to canvas bottom edge
  width_mm: 430.0                  # Full usable X width (450 - 2×10)
  height_mm: 300.0                 # Full usable Y height (320 - 2×10)

# --- Z-axis seesaw states --------------------------------------------------
# Reference positions for the seesaw mechanism (Z=0 at one end, Z=80 at other).
# Higher Z = pen closer to paper.  Lower Z = airbrush closer to paper.
z_states:
  travel_mm: 40.0                  # Mid-range: both tools clear of paper
  pen_work_mm: 80.0                # Pen contacts paper (near Z-max endstop)
  airbrush_work_mm: 0.0            # Airbrush at spray height (near Z-min)

# --- Tool definitions -------------------------------------------------------
# All feed rates in mm/s.
# NOTE: For pen tracing jobs, operational speeds come from jobs.yaml.
#       These values are defaults for interactive mode and airbrush jobs.
tools:
  pen:
    xy_offset_mm: [0.0, 0.0]       # Calibrate with crosshair test
    feed_mm_s: 150.0                # Default drawing speed (interactive)
    travel_feed_mm_s: 400.0         # Default rapid speed (interactive)
    plunge_feed_mm_s: 20.0          # Default Z lowering speed (interactive)

  airbrush:
    xy_offset_mm: [0.0, 0.0]
    feed_mm_s: 100.0
    travel_feed_mm_s: 160.0
    plunge_feed_mm_s: 10.0
    spray_height_mm: 3.0            # Height above canvas when spraying

# --- Stepper / driver hardware ---------------------------------------------
# Documents the physical motor+driver+belt+pulley combination so calibration,
# motion tests, and printer.cfg generation stay consistent.
#
# All XY axes share the same motor/driver/belt/pulley combination.
# Z may differ -- update z_rotation_distance separately when wired.
steppers:
  motor_type: "0.9deg"              # 400 native full steps/rev
  full_steps_per_rotation: 400      # 0.9deg motor = 400 full steps
  driver: "DM542TE"
  driver_pulses_per_rev: 3200       # DIP-switch setting (8x for 0.9deg motor)
  wiring: "common_anode"            # Octopus drives +, - to GND
  enable_pin_inverted: false        # common_anode -> enable is NOT inverted
  step_pulse_duration_s: 0.000005   # 5 us -- required for DM542TE via LS08
  direction_reversal_pause_s: 0.5   # 500 ms pause between rapid reversals

  # Klipper stepper settings (derived from motor + driver)
  # Validation: full_steps_per_rotation * klipper_microsteps == driver_pulses_per_rev
  #             400 * 8 = 3200
  klipper_microsteps: 8             # 400 x 8 = 3200 = driver_pulses_per_rev
  xy_rotation_distance: 32.0        # GT2 belt (2 mm pitch) x 16T pulley
  z_rotation_distance: 32.0         # Same belt/pulley as XY

  # Belt & pulley specs (reference / calibration calculations)
  belt_type: "GT2"
  belt_pitch_mm: 2.0
  pulley_teeth: 16
  pulley_bore_mm: 5.0

# --- Axis-to-Motor mapping (Octopus Pro V1.0.1 H723) ----------------------
# Pin assignments validated during hardware bring-up (test_motors.py).
# Used by printer.cfg generator and calibration routines.
#
# Klipper config mapping:
#   [stepper_x]  = x.pins[0] (primary)
#   [stepper_x1] = x.pins[1] (secondary, auto-synced via LookupMultiRail)
#   [stepper_y]  = y.pins
#   [stepper_z]  = z.pins (dummy, not physically homed)
axes:
  y:
    octopus_slot: "Motor 0"
    motors: 1
    pins:
      step: "PF13"
      dir: "!PF12"                   # Inverted so Y=0 is at the endstop
      enable: "PF14"
    endstop_pin: "PG9"              # STOP_1
    endstop_polarity: "^!"          # pull-up + inverted (NO switch to GND)
    endstop_type: "NO_to_GND"
    homing_side: "min"              # Endstop at Y=0 (dir inverted to flip axis)
  x:
    octopus_slot: "Motor 2_1 + Motor 2_2"
    motors: 2                       # Dual motor (stepper_x + stepper_x1)
    pins:
      - step: "PF11"
        dir: "PG3"
        enable: "PG5"
      - step: "PG4"
        dir: "!PC1"                 # Inverted -- motors face each other
        enable: "PA0"
    endstop_pin: "PG6"              # STOP_0
    endstop_polarity: "^!"          # pull-up + inverted (NO switch to GND)
    endstop_type: "NO_to_GND"
    homing_side: "min"              # Endstop at 0
  z:
    octopus_slot: "Motor 1"         # DRIVER_1 slot
    motors: 1
    pins:
      step: "PG0"
      dir: "PG1"
      enable: "PF15"
    endstop_pin: "PG10"             # DIAG2 / STOP_2 position -- physical limit switch
    endstop_polarity: "^!"          # pull-up + inverted (NO switch to GND)
    endstop_type: "NO_to_GND"
    homing_side: "max"              # Endstop at position 80 (far end of seesaw belt)

# --- Motion limits ----------------------------------------------------------
# Validated during hardware bring-up speed ramp tests (2026-02-12).
motion:
  max_velocity_mm_s: 500.0          # 2x previous; DM542TE at 8 microsteps allows higher speeds
  max_accel_mm_s2: 3000.0           # 2x previous
  square_corner_velocity_mm_s: 16.0 # 2x previous
  homing_speed_mm_s: 32.0           # ~1 RPS with 32 mm rotation_distance
  z_homing_speed_mm_s: 20.0         # 2x previous; still slower than XY due to less endstop play
  junction_deviation_mm: 0.05

# --- Interactive mode settings ----------------------------------------------
interactive:
  jog_increments_mm: [0.1, 1.0, 10.0, 50.0]
  default_jog_increment_mm: 1.0
  position_poll_interval_ms: 100

# --- File execution (virtual_sdcard) ----------------------------------------
file_execution:
  gcode_directory: "/home/klipper/gcode_files"

# --- Future hardware (disabled) ---------------------------------------------
pumps:
  enabled: false
servos:
  enabled: false
